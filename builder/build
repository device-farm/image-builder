#!/bin/bash
set -e

cd $1

echo "Building installer image in $(pwd)"

addVar() {
    KEY=$1
    VALUE=$2
    echo "$KEY=\"$VALUE\""
    eval "$KEY=\"$VALUE\""
    DOCKER_BUILD_ARGS="$DOCKER_BUILD_ARGS --build-arg \"$KEY=$VALUE\""
    echo "$KEY=\"$VALUE\"" >>$DOCKER_CTX/root/etc/defa/build
}

DIRS=$1
while true; do
    INV_DIRS="$DIRS $INV_DIRS"
    if [ $(basename $DIRS) = boards ]; then
        break
    fi
    DIRS=$(dirname $DIRS)
done

DOCKER_CTX=/tmp/build-ctx
rm -rf $DOCKER_CTX
mkdir -p $DOCKER_CTX/root/etc/defa

for DIR in $INV_DIRS; do

    for FILE in $(find $DIR -maxdepth 1 -type f)
    do
        if [[ $FILE =~ .*\.append$ ]]
        then
            DST=$DOCKER_CTX/$(basename $(sed s/.append$// <<<$FILE))
            cat $FILE >>$DST
        else
            cp $FILE $DOCKER_CTX
        fi
    done

    if [ -d $DIR/[root] ]
    then
        cp -r $DIR/[root]/. $DOCKER_CTX/root
    fi
done

date --iso-8601=seconds >>$DOCKER_CTX/_BUILD_DATE

addVar BOARD_ID $(basename $1)
for FILE in $DOCKER_CTX/_*
do    
    KEY=$(echo $(basename $FILE) | sed s/^.//)
    VALUE=$(cat $DOCKER_CTX/_$KEY)
    addVar "$KEY" "$VALUE"
done

tree $DOCKER_CTX

DOCKER_IMAGE=$INSTALL_REPO/install-$BOARD_ID
sh -c "docker buildx build --progress=plain --load $DOCKER_BUILD_ARGS $DOCKER_CTX -t $DOCKER_IMAGE"
echo "Published as $DOCKER_IMAGE"


